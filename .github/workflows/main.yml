name: Microservices CI/CD Pipeline

on:
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      deploy_gateway:
        description: 'Deploy spring-petclinic-api-gateway'
        required: false
        type: boolean
      deploy_customers:
        description: 'Deploy spring-petclinic-customers-service'
        required: false
        type: boolean
      deploy_vets:
        description: 'Deploy spring-petclinic-vets-service'
        required: false
        type: boolean
      deploy_visits:
        description: 'Deploy spring-petclinic-visits-service'
        required: false
        type: boolean
      deploy_discovery:
        description: 'Deploy spring-petclinic-discovery-server'
        required: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_KEY: ${{ secrets.EC2_KEY }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Determine trigger mode (manual or auto)
      id: mode
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "mode=manual" >> $GITHUB_OUTPUT
        else
          echo "mode=auto" >> $GITHUB_OUTPUT
        fi

    - name: Determine changed services (auto mode only)
      if: steps.mode.outputs.mode == 'auto'
      id: changed
      run: |
        git fetch origin dev
        CHANGED=$(git diff --name-only HEAD^ HEAD)

        echo "changed_gateway=false" >> $GITHUB_OUTPUT
        echo "changed_customers=false" >> $GITHUB_OUTPUT
        echo "changed_vets=false" >> $GITHUB_OUTPUT
        echo "changed_visits=false" >> $GITHUB_OUTPUT
        echo "changed_discovery=false" >> $GITHUB_OUTPUT

        if echo "$CHANGED" | grep -q 'spring-petclinic-api-gateway/'; then echo "changed_gateway=true" >> $GITHUB_OUTPUT; fi
        if echo "$CHANGED" | grep -q 'spring-petclinic-customers-service/'; then echo "changed_customers=true" >> $GITHUB_OUTPUT; fi
        if echo "$CHANGED" | grep -q 'spring-petclinic-vets-service/'; then echo "changed_vets=true" >> $GITHUB_OUTPUT; fi
        if echo "$CHANGED" | grep -q 'spring-petclinic-visits-service/'; then echo "changed_visits=true" >> $GITHUB_OUTPUT; fi
        if echo "$CHANGED" | grep -q 'spring-petclinic-discovery-server/'; then echo "changed_discovery=true" >> $GITHUB_OUTPUT; fi

    - name: Convert PEM key
      run: echo "$EC2_KEY" > key.pem && chmod 600 key.pem

    - name: Deploy each service
      run: |
        deploy_service() {
          NAME=$1
          PATH=$2

          echo "Deploying $NAME..."
          cd $PATH
          mvn test
          mvn package -DskipTests
          scp -i ../../key.pem target/*.jar $EC2_USER@$EC2_HOST:/home/$EC2_USER/$NAME.jar
          ssh -i ../../key.pem $EC2_USER@$EC2_HOST "pkill -f $NAME.jar || true && nohup java -jar /home/$EC2_USER/$NAME.jar > /dev/null 2>&1 &"
          cd -
        }

        # Manual Mode Deploy
        if [[ "${{ steps.mode.outputs.mode }}" == "manual" ]]; then
          ${{ inputs.deploy_gateway && 'deploy_service "gateway" "spring-petclinic-api-gateway"' || ':' }}
          ${{ inputs.deploy_customers && 'deploy_service "customers" "spring-petclinic-customers-service"' || ':' }}
          ${{ inputs.deploy_vets && 'deploy_service "vets" "spring-petclinic-vets-service"' || ':' }}
          ${{ inputs.deploy_visits && 'deploy_service "visits" "spring-petclinic-visits-service"' || ':' }}
          ${{ inputs.deploy_discovery && 'deploy_service "discovery" "spring-petclinic-discovery-server"' || ':' }}
        else
          # Auto Mode Deploy
          ${{ steps.changed.outputs.changed_gateway == 'true' && 'deploy_service "gateway" "spring-petclinic-api-gateway"' || ':' }}
          ${{ steps.changed.outputs.changed_customers == 'true' && 'deploy_service "customers" "spring-petclinic-customers-service"' || ':' }}
          ${{ steps.changed.outputs.changed_vets == 'true' && 'deploy_service "vets" "spring-petclinic-vets-service"' || ':' }}
          ${{ steps.changed.outputs.changed_visits == 'true' && 'deploy_service "visits" "spring-petclinic-visits-service"' || ':' }}
          ${{ steps.changed.outputs.changed_discovery == 'true' && 'deploy_service "discovery" "spring-petclinic-discovery-server"' || ':' }}
        fi
