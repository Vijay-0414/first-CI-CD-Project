name: Build and Push Docker image to ECR

on:
  workflow_dispatch:
    inputs:
      deploy_gateway:  #spring-petclinic-api-gateway
        type: boolean
        default: false
      deploy_customers:  #spring-petclinic-customer-service
        type: boolean
        default: false
      deploy_vets:  #spring-petclinic-vets-service
        type: boolean
        default: false
      deploy_visits:  #spring-petclinic-visits-service
        type: boolean
        default: false
      deploy_discovery:  #spring-petclinic-discovery-server
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CLUSTER_NAME: Micro-cluster

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Set short git commit SHA
      id: vars
      run: |
        calculatedSha=$(git rev-parse --short ${{ github.sha }})
        echo "COMMIT_SHORT_SHA=$calculatedSha" >> $GITHUB_ENV

    - name: Github Workspace
      run: echo ${{ github.workspace }}

    - name: Confirm git commit SHA output
      run: echo ${{ env.COMMIT_SHORT_SHA }}

    # TEST + BUILD ONLY SELECTED SERVICES
    - name: Test & build selected services
      run: |
        if [ "${{ inputs.deploy_gateway }}" == "true" ]; then
          cd spring-petclinic-api-gateway && mvn test && mvn package -DskipTests && cd ..
        fi
        if [ "${{ inputs.deploy_customers }}" == "true" ]; then
          cd spring-petclinic-customers-service && mvn test && mvn package -DskipTests && cd ..
        fi
        if [ "${{ inputs.deploy_vets }}" == "true" ]; then
          cd spring-petclinic-vets-service && mvn test && mvn package -DskipTests && cd ..
        fi
        if [ "${{ inputs.deploy_visits }}" == "true" ]; then
          cd spring-petclinic-visits-service && mvn test && mvn package -DskipTests && cd ..
        fi
        if [ "${{ inputs.deploy_discovery }}" == "true" ]; then
          cd spring-petclinic-discovery-server && mvn test && mvn package -DskipTests && cd ..
        fi

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{secrets.AWS_ACCESS_KEY}}
        aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
        aws-region: ${{secrets.AWS_REGION}}

    - name: Login to Amazon ECR
      id: login-ecr
      run: |
        aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          
    - name: Build and Push Docker Images
      run: |  

        if [ "${{ inputs.deploy_gateway }}" = "true" ]; then
          docker build -t ${{ secrets.ECR_REGISTRY }}/api-gateway:${{ env.COMMIT_SHORT_SHA }} spring-petclinic-api-gateway
          docker push ${{ secrets.ECR_REGISTRY }}/api-gateway:${{ env.COMMIT_SHORT_SHA }}
          docker tag ${{ secrets.ECR_REGISTRY }}/api-gateway:${{ env.COMMIT_SHORT_SHA }} ${{ secrets.ECR_REGISTRY }}/api-gateway:latest
          docker push ${{ secrets.ECR_REGISTRY }}/api-gateway:latest
        fi


        if [ "${{inputs.deploy_customers}}" == "true" ]; then
          docker build -t ${{ secrets.ECR_REGISTRY }}/customers-service:${{ env.COMMIT_SHORT_SHA }} spring-petclinic-customers-service
          docker push ${{ secrets.ECR_REGISTRY }}/customers-service:${{ env.COMMIT_SHORT_SHA }}
          docker tag ${{ secrets.ECR_REGISTRY }}/customers-service:${{ env.COMMIT_SHORT_SHA }} ${{ secrets.ECR_REGISTRY }}/customers-service:latest
          docker push ${{ secrets.ECR_REGISTRY }}/customers-service:latest
        fi
        if [ "${{inputs.deploy_vets}}" == "true" ]; then
          docker build -t ${{ secrets.ECR_REGISTRY }}/vets-service:${{ env.COMMIT_SHORT_SHA }} spring-petclinic-vets-service
          docker push ${{ secrets.ECR_REGISTRY }}/vets-service:${{ env.COMMIT_SHORT_SHA }}
          docker tag ${{ secrets.ECR_REGISTRY }}/vets-service:${{ env.COMMIT_SHORT_SHA }} ${{ secrets.ECR_REGISTRY }}/vets-service:latest
          docker push ${{ secrets.ECR_REGISTRY }}/vets-service:latest
          
        fi
        if [ "${{inputs.deploy_visits}}" == "true" ]; then
          docker build -t ${{ secrets.ECR_REGISTRY }}/visits-service:${{ env.COMMIT_SHORT_SHA }} spring-petclinic-visits-service
          docker push ${{ secrets.ECR_REGISTRY }}/visits-service:${{ env.COMMIT_SHORT_SHA }}
          docker tag ${{ secrets.ECR_REGISTRY }}/visits-service:${{ env.COMMIT_SHORT_SHA }} ${{ secrets.ECR_REGISTRY }}/visits-service:latest
          docker push ${{ secrets.ECR_REGISTRY }}/visits-service:latest
        fi
        if [ "${{inputs.deploy_discovery}}" == "true" ]; then
          docker build -t ${{ secrets.ECR_REGISTRY }}/discovery-server:${{ env.COMMIT_SHORT_SHA }} spring-petclinic-discovery-server
          docker push ${{ secrets.ECR_REGISTRY }}/discovery-server:${{ env.COMMIT_SHORT_SHA }}
          docker tag ${{ secrets.ECR_REGISTRY }}/discovery-server:${{ env.COMMIT_SHORT_SHA }} ${{ secrets.ECR_REGISTRY }}/discovery-server:latest
          docker push ${{ secrets.ECR_REGISTRY }}/discovery-server:latest
        fi
        
    - name: Create ECS cluster if not exists
      run: |
        CLUSTER_EXISTS=$(aws ecs describe-clusters --clusters $CLUSTER_NAME --region ${{secrets.AWS_REGION}} --query "clusters[0].status" --output text 2>/dev/null || echo "MISSING")
        
        if [ "$CLUSTER_EXISTS" = "MISSING" ] || [ "$CLUSTER_EXISTS" = "INACTIVE" ] || [ "$CLUSTER_EXISTS" = "None" ]; then
          echo "$CLUSTER_NAME Cluster not found. Creating $CLUSTER_NAME ECS cluster..."
          aws ecs create-cluster --cluster-name $CLUSTER_NAME --region ${{secrets.AWS_REGION}}
        else
          echo "ECS cluster '$CLUSTER_NAME' already exists."
        fi

    - name: Launch EC2 instances if none exist
      run: |
        COUNT=$(aws ecs list-container-instances --cluster $CLUSTER_NAME --region ${{secrets.AWS_REGION}} --query "length(containerInstanceArns)" --output text)
        if [ "$COUNT" -eq 0 ]; then
          echo "Launching EC2 container instance..."
          AMI_ID=$(aws ssm get-parameters --names /aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id --query "Parameters[0].Value" --output text)
          aws ec2 run-instances \
            --image-id $AMI_ID \
            --count 1 \
            --instance-type t3.medium \
            --iam-instance-profile Name=ecsInstanceRole \
            --key-name my-key \
            --security-group-ids sg-0abb4251606ddb157 \
            --subnet-id subnet-02cad20bf83afac11 \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=Micro-Instance}]" \
            --user-data "#!/bin/bash
            echo ECS_CLUSTER=$CLUSTER_NAME >> /etc/ecs/ecs.config"
        else
          echo "EC2 container instances already running."
        fi

    - name: Task Creation
      run: |
        if [ "${{ inputs.deploy_gateway }}" == "true" ]; then
        
          SERVICE_NAME=gateway-service
          TASK_NAME=gateway-task
        
          echo "Update and Register Task Definition"
          
          sed "s|REPLACE_ME|${{ secrets.ECR_REGISTRY }}/api-gateway:${{ env.COMMIT_SHORT_SHA }}|g" ecs-task-definitions/api-gateway-task-def.json > final-task-def.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
        
          echo "Deregistering OLD Task Definition"
        
          OLD_REVISIONS=$(aws ecs list-task-definitions --family-prefix $TASK_NAME --status ACTIVE --sort DESC --query 'taskDefinitionArns[1:]' --output text)

          for TD_ARN in $OLD_REVISIONS; do
            echo "Deregistering $TD_ARN"
            aws ecs deregister-task-definition --task-definition $TD_ARN
          done
        
          echo "Stop Existing Service Task or Creating New Service"
        
          SERVICE_STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].status" --output text 2>/dev/null || echo "MISSING")

          if [ "$SERVICE_STATUS" == "ACTIVE" ]; then
            echo "Service exists. Checking for running tasks..."
            TASK_ARN=$(aws ecs list-tasks --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --query 'taskArns[0]' --output text)

            if [ "$TASK_ARN" != "None" ] && [ "$TASK_ARN" != "null" ]; then
              echo "Stopping task: $TASK_ARN"
              aws ecs stop-task --cluster $CLUSTER_NAME --task $TASK_ARN
            else
              echo "No running tasks found for service."
            fi
          else
            echo "Creating ECS service..."
            aws ecs create-service --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --task-definition $TASK_DEF_ARN --desired-count 1 --launch-type EC2 --deployment-configuration maximumPercent=200,minimumHealthyPercent=50
          fi
        
          echo "Updating the Service"
        
          aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_DEF_ARN --force-new-deployment
        fi

        if [ "${{ inputs.deploy_vets }}" == "true" ]; then
        
          SERVICE_NAME=vets-service
          TASK_NAME=vets-task
        
          echo "Update and Register Task Definition"
          
          sed "s|REPLACE_ME|${{ secrets.ECR_REGISTRY }}/vets-service:${{ env.COMMIT_SHORT_SHA }}|g" ecs-task-definitions/vets-service-task-def.json > final-task-def.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
        
          echo "Deregistering OLD Task Definition"
        
          OLD_REVISIONS=$(aws ecs list-task-definitions --family-prefix $TASK_NAME --status ACTIVE --sort DESC --query 'taskDefinitionArns[1:]' --output text)

          for TD_ARN in $OLD_REVISIONS; do
            echo "Deregistering $TD_ARN"
            aws ecs deregister-task-definition --task-definition $TD_ARN
          done
        
          echo "Stop Existing Service Task or Creating New Service"
        
          SERVICE_STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].status" --output text 2>/dev/null || echo "MISSING")

          if [ "$SERVICE_STATUS" == "ACTIVE" ]; then
            echo "Service exists. Checking for running tasks..."
            TASK_ARN=$(aws ecs list-tasks --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --query 'taskArns[0]' --output text)

            if [ "$TASK_ARN" != "None" ] && [ "$TASK_ARN" != "null" ]; then
              echo "Stopping task: $TASK_ARN"
              aws ecs stop-task --cluster $CLUSTER_NAME --task $TASK_ARN
            else
              echo "No running tasks found for service."
            fi
          else
            echo "Creating ECS service..."
            aws ecs create-service --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --task-definition $TASK_DEF_ARN --desired-count 1 --launch-type EC2 --deployment-configuration maximumPercent=200,minimumHealthyPercent=50
          fi
        
          echo "Updating the Service"
        
          aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_DEF_ARN --force-new-deployment
        fi

        if [ "${{ inputs.deploy_customers }}" == "true" ]; then
        
          SERVICE_NAME=customers-service
          TASK_NAME=customers-task
        
          echo "Update and Register Task Definition"
          
          sed "s|REPLACE_ME|${{ secrets.ECR_REGISTRY }}/customers-service:${{ env.COMMIT_SHORT_SHA }}|g" ecs-task-definitions/customers-service-task-def.json > final-task-def.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
        
          echo "Deregistering OLD Task Definition"
        
          OLD_REVISIONS=$(aws ecs list-task-definitions --family-prefix $TASK_NAME --status ACTIVE --sort DESC --query 'taskDefinitionArns[1:]' --output text)

          for TD_ARN in $OLD_REVISIONS; do
            echo "Deregistering $TD_ARN"
            aws ecs deregister-task-definition --task-definition $TD_ARN
          done
        
          echo "Stop Existing Service Task or Creating New Service"
        
          SERVICE_STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].status" --output text 2>/dev/null || echo "MISSING")

          if [ "$SERVICE_STATUS" == "ACTIVE" ]; then
            echo "Service exists. Checking for running tasks..."
            TASK_ARN=$(aws ecs list-tasks --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --query 'taskArns[0]' --output text)

            if [ "$TASK_ARN" != "None" ] && [ "$TASK_ARN" != "null" ]; then
              echo "Stopping task: $TASK_ARN"
              aws ecs stop-task --cluster $CLUSTER_NAME --task $TASK_ARN
            else
              echo "No running tasks found for service."
            fi
          else
            echo "Creating ECS service..."
            aws ecs create-service --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --task-definition $TASK_DEF_ARN --desired-count 1 --launch-type EC2 --deployment-configuration maximumPercent=200,minimumHealthyPercent=50
          fi
        
          echo "Updating the Service"
        
          aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_DEF_ARN --force-new-deployment
        fi

        if [ "${{ inputs.deploy_visits }}" == "true" ]; then
        
          SERVICE_NAME=visits-service
          TASK_NAME=visits-task
        
          echo "Update and Register Task Definition"
          
          sed "s|REPLACE_ME|${{ secrets.ECR_REGISTRY }}/visits-service:${{ env.COMMIT_SHORT_SHA }}|g" ecs-task-definitions/visits-service-task-def.json > final-task-def.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
        
          echo "Deregistering OLD Task Definition"
        
          OLD_REVISIONS=$(aws ecs list-task-definitions --family-prefix $TASK_NAME --status ACTIVE --sort DESC --query 'taskDefinitionArns[1:]' --output text)

          for TD_ARN in $OLD_REVISIONS; do
            echo "Deregistering $TD_ARN"
            aws ecs deregister-task-definition --task-definition $TD_ARN
          done
        
          echo "Stop Existing Service Task or Creating New Service"
        
          SERVICE_STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].status" --output text 2>/dev/null || echo "MISSING")

          if [ "$SERVICE_STATUS" == "ACTIVE" ]; then
            echo "Service exists. Checking for running tasks..."
            TASK_ARN=$(aws ecs list-tasks --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --query 'taskArns[0]' --output text)

            if [ "$TASK_ARN" != "None" ] && [ "$TASK_ARN" != "null" ]; then
              echo "Stopping task: $TASK_ARN"
              aws ecs stop-task --cluster $CLUSTER_NAME --task $TASK_ARN
            else
              echo "No running tasks found for service."
            fi
          else
            echo "Creating ECS service..."
            aws ecs create-service --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --task-definition $TASK_DEF_ARN --desired-count 1 --launch-type EC2 --deployment-configuration maximumPercent=200,minimumHealthyPercent=50
          fi
        
          echo "Updating the Service"
        
          aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_DEF_ARN --force-new-deployment
        fi

        if [ "${{ inputs.deploy_discovery }}" == "true" ]; then
        
          SERVICE_NAME=discovery-service
          TASK_NAME=discovery-task
        
          echo "Update and Register Task Definition"
          
          sed "s|REPLACE_ME|${{ secrets.ECR_REGISTRY }}/discovery-service:${{ env.COMMIT_SHORT_SHA }}|g" ecs-task-definitions/discovery-server-task-def.json > final-task-def.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://final-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
        
          echo "Deregistering OLD Task Definition"
        
          OLD_REVISIONS=$(aws ecs list-task-definitions --family-prefix $TASK_NAME --status ACTIVE --sort DESC --query 'taskDefinitionArns[1:]' --output text)

          for TD_ARN in $OLD_REVISIONS; do
            echo "Deregistering $TD_ARN"
            aws ecs deregister-task-definition --task-definition $TD_ARN
          done
        
          echo "Stop Existing Service Task or Creating New Service"
        
          SERVICE_STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].status" --output text 2>/dev/null || echo "MISSING")

          if [ "$SERVICE_STATUS" == "ACTIVE" ]; then
            echo "Service exists. Checking for running tasks..."
            TASK_ARN=$(aws ecs list-tasks --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --query 'taskArns[0]' --output text)

            if [ "$TASK_ARN" != "None" ] && [ "$TASK_ARN" != "null" ]; then
              echo "Stopping task: $TASK_ARN"
              aws ecs stop-task --cluster $CLUSTER_NAME --task $TASK_ARN
            else
              echo "No running tasks found for service."
            fi
          else
            echo "Creating ECS service..."
            aws ecs create-service --cluster $CLUSTER_NAME --service-name $SERVICE_NAME --task-definition $TASK_DEF_ARN --desired-count 1 --launch-type EC2 --deployment-configuration maximumPercent=200,minimumHealthyPercent=50
          fi
        
          echo "Updating the Service"
        
          aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $TASK_DEF_ARN --force-new-deployment
        fi

